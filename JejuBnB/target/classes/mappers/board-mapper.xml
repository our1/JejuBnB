<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE mapper PUBLIC
"-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="boardMapper">
	<resultMap id="resultBoard" type="Board" >
	
		<id property="board_num" column="board_num"/>
		<result property="board_title" column="board_title"/>
		<result property="board_writer" column="board_writer"/>
		<result property="board_content" column="board_content"/>
		<result property="board_original_filename" column="board_original_filename"/>
		<result property="board_rename_filename" column="board_rename_filename"/>
		<result property="board_date" column="board_date"/>
		<result property="board_level" column="board_level"/>
		<result property="board_ref" column="board_ref"/>
		<result property="board_reply_ref" column="board_reply_ref"/>
		<result property="board_reply_seq" column="board_reply_seq"/>
		<result property="board_readcount" column="board_readcount"/>
	</resultMap>
	
	<resultMap id="resultTop3" type="Board" >
	<id property="board_num" column="board_num"/>
	<result property="board_title" column="board_title"/>
	<result property="board_readcount" column="board_readcount"/>
	</resultMap>
	
	<select id="selectTop3" resultMap="resultTop3">
	<![CDATA[
	SELECT * FROM (SELECT ROWNUM RNUM, BOARD_NUM, BOARD_TITLE, BOARD_READCOUNT 
				      FROM (SELECT * FROM BOARD WHERE BOARD_LEVEL = 0 
				           ORDER BY BOARD_READCOUNT DESC)) WHERE RNUM >= 1 AND RNUM <= 3
	
	]]>
	</select>
	<select id="getListCount" resultType="int">
	SELECT COUNT(*) FROM BOARD
	</select>
	<select id="selectList"  parameterType="com.jeju.JejuBnB.board.model.vo.BoardPage" resultMap="resultBoard" >
	<![CDATA[
	SELECT * 
				FROM (SELECT ROWNUM RNUM, BOARD_NUM, BOARD_TITLE, BOARD_WRITER, BOARD_CONTENT, BOARD_ORIGINAL_FILENAME, 
				BOARD_RENAME_FILENAME, BOARD_DATE, BOARD_LEVEL, BOARD_REF, BOARD_REPLY_REF, 
				                                    BOARD_REPLY_SEQ, BOARD_READCOUNT  
				           FROM (SELECT * FROM BOARD 
		                        ORDER BY BOARD_REF DESC, BOARD_REPLY_REF DESC, 
			                                        BOARD_LEVEL ASC, BOARD_REPLY_SEQ ASC)) 
				WHERE RNUM >= #{startRow} AND RNUM <= #{endRow}
	]]>
	</select>
	<select id="selectBoard" parameterType="int" resultMap="resultBoard">
	select * from board where board_num = #{board_num}
	</select>
	<insert id="insertOriginBoard" parameterType="Board">
	insert into board values ((select max(board_num) + 1 from board), #{board_title} , #{board_writer} ,
	 #{board_content} 
	 <if test="board_original_filename != null">
	 , #{board_original_filename} , #{board_rename_filename} 
	 </if>
	  <if test="board_original_filename == null">
	  ,null , null
	  </if>
	 , sysdate, 0,
				 (select max(board_num)+ 1 from board ), default, default, default)
	</insert>
	<insert id="insertReply1" parameterType="Board">
	insert into board 
	values ((select max(board_num) + 1 from board), #{board_title} , #{board_writer} ,
	 #{board_content} , null , null , sysdate, 1 ,#{board_ref} ,
				 (select max(board_num)+ 1 from board ), #{board_reply_seq}, default)
	
	</insert>
	<insert id="insertReply2" parameterType="Board">
	insert into board values ((select max(board_num) + 1 from board), #{board_title} , #{board_writer} , #{board_content}
	 , null , null , sysdate, 2, #{board_ref}, #{board_reply_ref}, #{board_reply_seq}, default)
	
	</insert>
	<update id="addReadCount" parameterType="int">
	update board set board_readcount = board_readcount + 1 where board_num = #{board_num}
	</update>
	<update id="updateReplySeq1" parameterType="Board">
	update board set board_reply_seq = board_reply_seq + 1 where board_ref = #{board_ref} and board_level = #{board_level}
	</update>
	<update id="updateReplySeq2" parameterType="Board">
	update board set board_reply_seq = board_reply_seq + 1 where board_ref = #{board_ref} and board_level = #{board_level} and board_reply_ref = #{board_reply_ref}
	</update>
	<update id="updateReply" parameterType="Board" >
	update board set board_title = #{board_title}, board_content =#{board_content} where board_num = #{board_num}
	</update>
	<update id="updateOrigin" parameterType="Board">
	update board set board_title = #{board_title}, board_content =#{board_content}
	<if test="board_original_filename != null">
	, 
	board_original_filename = #{board_original_filename} , board_rename_filename =#{board_rename_filename}
	</if>
	<if test="board_original_filename == null">
	, 
	board_original_filename = null , board_rename_filename = null
	</if>
	 where board_num = #{board_num}
	</update>
	
	
	<delete id="deleteBoard" parameterType="Board">
		delete from board 
		<if test="board_level == 0">
			where board_ref = #{board_num} 
		</if>
		<if test="board_level == 1">	
			where board_reply_ref = #{board_num}
		</if>  
		<if test="board_level == 2">	
			where board_num = #{board_num} 
		</if>
	</delete>
	
</mapper>
